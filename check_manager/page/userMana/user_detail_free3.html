<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<script src="../../../js/mui.min.js"></script>
	<link rel="stylesheet" href="../../../css/scale.css">
	<link rel="stylesheet" href="../../../css/mui.min.css">
	<script src="../../../js/mescroll.min.js"></script>
	<link rel="stylesheet" href="../../../css/mescroll.min.css">
	<title>风控--用户--详情--协议</title>
			
		<style type="text/css">
			body { margin: 0; padding: 0; color: #333333; }
			header { position: fixed; top:0; left: 0; z-index: 50; width: 100%; line-height: 44px; height: 44px; background-color: #FFF; box-shadow: 0 2px 2px 0 rgba(231,231,231,1); text-align: center;}
			header>img { position: absolute; top: 12px; left: 5px; width: 20px; height: 20px; }
			.occupy {width: 100%; height: 46px; background-color: #ddd; margin-bottom: 20px;}
			
			.list>div {
				background-color: #FFF;
				position: relative;
				width: 100%;
				margin-top:4px;
			}
			
			.list>div>div {
				width: 100%;
				height: 40px;
				display: flex;
				justify-content: flex-end;
				align-items: center;
				border-bottom: 1px solid rgb(240, 240, 240);
				font-size: 14px;
				padding: 0 5px 0 15px;
			}
			
			.list>div img {
				width: 25px;
				height: 25px;
				vertical-align: middle;
			}
			
			.time {
				color: #999999;
			}
			
			/* .contype {
				height: 30px; line-height: 30px; font-size: 12px; color: #222;
			} */
			.list .href{ display: flex; justify-content: flex-end; align-items: center;}
			
			/* --------- 弹出平台协议的样式------  */
			.ctra-dialog {background-color: #FFF; display: none; position: fixed; width: 100%; height: 100vh; overflow-y: auto; left: 0; top: 0; z-index: 100;}
			
			.ctra-header {
					position: fixed;
					top: 0;
					left: 0;
					text-align: center;
					width: 100%;
					height: 44px;
					line-height: 44px;
					background-color: white;
					box-shadow: 0 2px 2px 0 rgba(231, 231, 231, 1);
					font-weight: bold;
					font-size: 16px;
			}
			
			.ctra-header>img {
					position: absolute;
					top: 12px;
					left: 5px;
					width: 20px;
					height: 20px;
			}
			p {margin: 0;}
			.itemContent {
					width: 100%;
					height: calc(100vh - 20px);
					margin-top: 20px;
					padding: 15px 8px 0 15px;
			}
			.type-title{
				margin: 60px 0 20px; border: 1px solid #7EB6FF; color: #7EB6FF; height: 44px; line-height: 44px; font-size: 18px; text-align: center;
			}
			
			
			.imgBox {
				width: 96%;
				height: 70vh;
				border: 1px solid #aaaaaa;
				margin: 10px auto;
			}
			
			.imgBox>img {
			    width: 100%;
			    height: 100%;
			}
			
			
			
			
			.select-back {
				position: absolute;
				width: 80px;
				/* line-height: 46px; */
				color: #7EB6FF;
				top: 0;
				left: 5px;
			}
			footer {
				position: fixed;
				bottom: 0;
				left: 0;
				width: 100%;
				height: 50px;
				background-color: white;
				display: none;
				/* display: flex; */
				justify-content: space-around;
				align-items: center;
			}
			.footer-item { 
				border-radius: 5px; 
				width: 45%; height: 43px; 
				line-height: 43px; 
				text-align: center;
				border: 1px solid #7EB6FF;
			}
			.nopass { color: #7EB6FF; }
			.pass { background-color: #7EB6FF; color: #fff; }
		</style>
	</head>
	<body>
		<!-- 装 每个协议的容器 -->
		<div class="ctra-dialog">
			<header class="ctra-header">
			  <!-- <img class="back" src="../../img/back_black.png" alt=""> 慧业通服务平台条款 -->
				<div class="back select-back"><<返回</div>
				<span class="title-span">协议详情</span>
			</header>
			<div class="type-title"></div>
			<div class="itemContent">
			
			</div>
			<!-- 图片预览放大的功能 -->
			<!-- <section class="imgzoom_pack">
				<div class="imgzoom_x">X</div>
				<div class="imgzoom_img"><img src="" /></div>
			</section> -->
		</div>
		
		
		
		
		<header>
			<img class="back" src="../../../img/back_black.png" alt="">
			<span>协议文本(3)</span>
		</header>
		<div class="occupy"></div>
	
		<!-- 数据列表 -->
		<section class="list">
			<!-- <div>
				<div class="comTime">
					<div class="contype" typeid="${data[i].type}">协议类型</div>
					<div class="href" detailId="${data[i].id}">
						<span class="time">名字协议</span>
						<img src="../../../img/next.png" alt="">
					</div>
					
				</div>
			</div> -->
			
		</section>
		
		<footer>
			<div class="footer-item nopass">退回</div>
			<div class="footer-item pass"> 通过</div>
		</footer>
	</body>
	<script src="../../../js/jquery-3.3.1.js"></script>
	<script src="../../js/layer/layer.js"></script>
	<script src="../../../js/urlDns.js"></script>
	<script src="../../../js/scale.js"></script>
	
	<script type="text/javascript">
		
		mui.init({
			beforeback: function() {
				if(is_agree){
					backActive()
					return false
				}
				else{ 
					// history.go(-2)
					return true 
				}
			}
		})
		// 返回=======================
		$(".back").click(() => {
			mui.back();
		});
		// 返回之前要执行的操作 函数
		function backActive() {
			if(is_agree) {
				$(".ctra-dialog").css("display","none")
				is_agree = false
			}
		}
	
		var pass_app = localStorage.getItem("pass_app");
		var tel_app = localStorage.getItem("tel_app");
		var code_app = localStorage.getItem("code_app");
	
		// 用户是否处在 条款详情页
		var is_agree = false   
		// 获取用户id
		let detailId = sessionStorage.getItem("detailId")
		// 获取状态码
		var income_status = sessionStorage.getItem("income_status");
		// console.log(income_status)
		if(income_status==7){
			$("footer").css("display","flex");
		}
	
		
		var page = 1 // 设置当前 在第几个页面
		
		getInfoList() //调用函数初始化 界面上要展示的数据列表
	
		function getInfoList() {
			// 请求数据
			mui.post(urlDns + "/control_app/ms/fr/user/get_xy_model_list", {
				// 进入的状态
				userid: detailId,
				pass_app: pass_app,
				tel_app: tel_app,
				code_app: code_app
			}, function(data) {
				// console.log(JSON.stringify(data));
				if (data.result == 0) {
					// 需要重新登录
					if (window.plus) {
						goToLogin("../../../page/register/login.html");
					} else {
						document.addEventListener('plusready', goToLogin, false);
					}
				} else {
					if(page==1){ $(".list").html(''); }   // 发起请求之前,先清空页面
					var htmlStr = "";
					for (let i = 0; i < data.length; i++) {
						htmlStr +=
						`
						<div>
							<div class="comTime">
								<div class="href" detailId="${data[i].id}" detailName="${data[i].name}">
									<span class="time">
									${
										(function(){
											if( data[i].type==1 ){ return "服务平台协议"}
											else if( data[i].type==2 ){ return "业者与单位协议"}
											else if( data[i].type==3 ){ return "单位与商秘公司协议"}
											else if( data[i].type==4 ){ return "三方协议"}
											else if( data[i].type==5 ){ return "业者与商秘公司协议"}
											else if( data[i].type==11 ){ return "合作伙伴与商秘公司协议"}
											else { return "空" }
										})()
									}
									</span>
									<img src="../../../img/next.png" alt="">
								</div>
							</div>
						</div>
						`;
					}
					$(".list").append(htmlStr);
				}
			});
		}
	
	 
		
		
		
		// ======================加载下一页===================================================
		// $(window).scroll(function() {
		// 	if ($(window).scrollTop() + $(window).height() == $(document).height()) {
		// 		page = page + 1;
		// 		// 发起ajax请求
		// 		getInfoList()
		// 	}
		// });
		
		
		$.ajaxSettings.async = false;   // 取消ajax的异步请求,, 让协议加载完成之后再做监听
		// 点击,查看协议详情
		$(document).on("click", ".list .href", function(e) {
			let detailCtraId = $(this).attr("detailId");
			// let typeid = $(this).attr("typeid");
			let detailName = $(this).attr("detailName");
			
			getCtraPplatform(detailCtraId, detailName)
		})
	
		// 点击item  执行加载 协议的函数
		function getCtraPplatform(id, detailName){
			is_agree = true
			$(".ctra-dialog").css("display","block")
			if ($(document.body).height() < $(window).height() - 185) {
			    // 减掉的64是除了$(".cont")以外其他元素的高度
			    $(".itemContent").css("height", "calc(100vh - 64px)");
			}
			
			if( detailName != "undefined" ){
				$(".type-title").text(detailName)
				}
			else {
				$(".itemContent").css("marginTop","60px")
				$(".type-title").css("display","none")
			}

			
			let ajaxPost = $.ajax({
				url: urlDns + "/control_app/ms/fr/user/get_xy_model_show",
				type: 'post',
				dataType: "json",
				timeout: 120000, //2分钟超时
				data: {
					id:id,
					pass_app: pass_app,
					tel_app: tel_app,
					code_app: code_app,
				},
				//请求成功
				success: function(data) {
					// console.log(JSON.stringify(data))
					if(data.type==1) {
						$(".itemContent").html(data.text);
					}
					else {
						let htmlStr = "";
						let img_arr = data.imgUrls.split(",")
						let len = img_arr.length || 0
						for (var i = 0; i < len; i++) {
								htmlStr += `
						<div class="imgBox">
								<img class="img-crt" src="${img_arr[i]}" alt="">
						</div>
						`;
						}
						$(".itemContent").html(htmlStr);
						
					// if ($(document.body).height() < $(window).height() - 185) {
					//     // 减掉的64是除了$(".cont")以外其他元素的高度
					//     $(".itemContent").css("height", "calc(100vh - 64px)");
					// } else {
					//     $(".itemContent").css("height", "100%");
					}
				},
				error: function(XMLHttpRequest, textStatus, errorThrown) {
					// layer.close(indexC);
					// console.log(textStatus)
					if (textStatus == 'timeout') {
							// console.log("请求超时");
							ajaxPost.abort();　
							alert("请求超时");
					}
					if (textStatus == 'error') {
							ajaxPost.abort();　
							alert("请求错误" + errorThrown);
					}
				}
			})
		}
		
	// 监听图片预览放大
	// window.document.addEventListener("DOMContentLoaded", function(event) {
	// 	console.log(90909)
	// 		ImagesZoom.init({
	// 			"elem": ".itemContent"
	// 		});
	// }, false)
	
	// 点击退回
	$(".nopass").click(() => {
		sessionStorage.setItem("itemid",detailId)
		sessionStorage.setItem("title","退回理由")
		sessionStorage.setItem("detail_content","")
		sessionStorage.setItem("user_type","416")
		location.href = "../business_content.html";
	})
	
		// 点击通过
		$(".pass").click(() => {
			$.post(urlDns + '/control_app/ms/fr/user/check', {
						ids: detailId,
						pass_app: pass_app,
						tel_app: tel_app,
						code_app: code_app
				}, function (data) {
						// console.log(JSON.stringify(data))
						if (data.result == 0) {
								// 需要重新登录
								if (window.plus) {
										goToLogin("../../../page/register/login.html");
								} else {
										document.addEventListener('plusready', goToLogin, false);
								}
						} 
						else {
							mui.alert('通过成功! !','提示','关闭',()=>{history.go(-3)},'div')
						}
				});
		})
	</script>
	</html>


