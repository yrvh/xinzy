<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="../../js/mui.min.js"></script>
    <link rel="stylesheet" href="../../css/mui.min.css">
    <link rel="stylesheet" href="../../css/scale.css">
    <title>上传协议图片</title>
		
		<style type="text/css">
			html,
			body {
			    width: 100%;
			    /* height: 100%; */
			    margin: 0;
			    padding: 0;
			}
			
			header {
			    position: relative;
			    width: 100%;
			    height: 44px;
			    background-color: white;
			    box-shadow: 0 2px 2px 0 rgba(231, 231, 231, 1);
			    text-align: center;
			    line-height: 44px;
			    font-weight: bold;
			}
			
			header>img {
			    position: absolute;
			    top: 12px;
			    left: 5px;
			    width: 20px;
			    height: 20px;
			}
			
			section {
			    width: 100%;
			    height: calc(100vh - 135px);
			    background-color: white;
			    margin-top: 20px;
			    overflow: hidden;
			}
			
			footer {
			    position: fixed;
			    bottom: 0;
			    left: 0;
			    width: 100%;
			    height: 50px;
			    background-color: white;
			    border-top: 1px solid #eeeeee;
			}
			
			footer>.complete {
			    width: calc(100% - 20px);
			    margin-left: 10px;
			    height: 40px;
			    margin-top: 4px;
			    color: white;
			    background-color: rgb(231, 231, 231);
			    text-align: center;
			    line-height: 40px;
			    border-radius: 4px;
			}
			
			.line {
			    width: 100%;
			    height: 1px;
			    background-color: white;
			    position: absolute;
			    top: -2px;
			    left: 0;
			}
			
			.imgBox {
			    position: relative;
			    float: left;
			    width: 26vw;
			    height: 26vw;
			    border: 1px dashed #cccccc;
			    margin: 3vw 0 0 calc((100vw - 78vw)/4);
			}
			
			.bgImg {
			    width: 50%;
			    height: 50%;
			    margin-left: 25%;
			    margin-top: 10%;
			}
			
			.imgBox .tips {
			    width: 100%;
			    text-align: center;
			    font-size: 15px;
			    color: #cccccc;
			}
			
			section .imgBox .targetImg {
			    position: absolute;
			    top: -1px;
			    left: -1px;
			    width: calc(100% + 2px);
			    height: calc(100% + 2px);
			}
			
			.clickBox {
			    width: 100%;
			    height: 100%;
			}
			
			.delBox {
			    position: absolute;
			    right: -9px;
			    top: -9px;
			    width: 20px;
			    height: 20px;
			    background-color: white;
			    border-radius: 50%;
			}
			
			.del {
			    position: absolute;
			    right: 0;
			    top: 0;
			    width: 20px;
			    height: 20px;
			}
			
			.black,
			.black2,
			.black3 {
			    width: 100%;
			    height: 100vh;
			    background-color: rgba(16, 16, 16, 0.1);
			    position: absolute;
			    top: 0;
			    left: 0;
			    z-index: 9;
			    display: none;
			}
			
			
			/* .black3 {
			    display: block;
			} */
			
			#jqmeter-container {
			    width: 270px;
			    margin: 0 auto;
			    margin-top: calc((100vh - 20px)/2);
			}
			
			.black>section,
			.black3>section {
			    position: relative;
			    width: 270px;
			    height: 144px;
			    border-radius: 13px;
			    background-color: white;
			    margin: 0 auto;
			    margin-top: calc((100vh - 144px)/2);
			}
			
			.cancel,
			.downLoad,
			.open,
			.close {
			    position: absolute;
			    bottom: 0;
			    width: 50%;
			    height: 45px;
			    text-align: center;
			    line-height: 45px;
			    border-top: 1px solid #e7e7e7;
			}
			
			.cancel,
			.close {
			    left: 0;
			    color: #666666;
			}
			
			.downLoad,
			.open {
			    right: 0;
			    color: #7EB6FF;
			    border-left: 1px solid #e7e7e7;
			}
			
			.openTips {
			    width: 100%;
			    height: 99px;
			    text-align: center;
			    line-height: 99px;
			    color: rgb(153, 153, 153);
			    font-size: 15px;
			}
			
			.tipTitle {
			    width: 100%;
			    padding-top: 15px;
			    color: #030303;
			    font-weight: 700;
			    text-align: center;
			}
			
			.tipCont {
			    font-size: 12px;
			    color: rgb(153, 153, 153);
			    padding: 0 35px;
			    text-align: center;
			    margin-top: 10px;
			}
		</style>
</head>

<body>
    <header>
        <img class="back" src="../../img/back_black.png" alt=""> 合同协议
    </header>
    <section class="photosBox">
        <div class="imgBox addImg">
            <img class="bgImg" src="../../img/camera.png" alt="">
            <div class="tips">上传图片</div>
        </div>

    </section>
    <!-- <section class="imgzoom_pack">
        <div class="imgzoom_x">X</div>
        <div class="imgzoom_img"><img src="" /></div>
    </section> -->
    <div class="black">
        <section>
            <div class="tipTitle">授权委托协议书</div>
            <div class="tipCont">自行下载打印协议书，并必须本人签字，交给选定的商务秘书公司</div>
            <section class="cancel">取消</section>
            <section class="downLoad">下载</section>
        </section>
    </div>
    <div class="black2">
        <div id="jqmeter-container"></div>
    </div>
    <div class="black3">
        <section>
            <div class="openTips">下载完成，是否打开文件</div>
            <div class="close">完成</div>
            <div class="open">打开</div>

        </section>

    </div>
    <footer>
        <div class="line"></div>
        <div class="complete">完成</div>
    </footer>

</body>
<script src="../../js/jquery-3.3.1.js"></script>
<script src="../../js/urlDns.js"></script>
<script src="../../js/jqmeter.min.js"></script>
<script src="../../js/scale.js"></script>

<script type="text/javascript">
	mui.init();
	$.ajaxSettings.async = false;
	$(".back").click(() => {
		mui.back()
	    // history.back();
	    // location.href = "./acceptCom.html";
	});
	
	// onLineContract页面是以contractImg的存在判断用户是否是上传
	// 图片的，为了避免用户还没完成注册返回来选择线上签协议，页面加载的时候
	// 清除一下缓存
	sessionStorage.removeItem("contractImg");
	
	// 获取接受服务单位的id
	var comid = sessionStorage.getItem("comids");
	console.log(comid)
	    // 手机号
	var tel = sessionStorage.getItem('tel');
	// 密码
	var password = sessionStorage.getItem('password');
	// 姓名
	var realname = sessionStorage.getItem('realname');
	// 邮箱
	var email = sessionStorage.getItem('email');
	// 身份证号
	var idCardNum = sessionStorage.getItem('idCardNum');
	// 开户机构
	var accountBank = sessionStorage.getItem('accountBank');
	// 开户名
	var accountName = sessionStorage.getItem('accountName');
	// 开户账号
	var account = sessionStorage.getItem('account');
	// 用户注册的角色
	var userType = sessionStorage.getItem('userType');
	// 选择的开票方式
	var type = localStorage.getItem('type');
	// 两张身份证照片
	var src1 = sessionStorage.getItem('idCardImg1');
	var src2 = sessionStorage.getItem('idCardImg2');
	var isUpdate = sessionStorage.getItem('isUpdate');
	// console.log(isUpdate)
	
	
	// 给上传图片框绑定点击事件
	$(document).on("click", ".addImg", imgUp);
	
	// 删除图片
	$(document).on("click", ".del", function(e) {
	    phptos -= 1;
	    if (phptos == 0) {
	        $(".tips").text("上传图片");
	        $(".complete").css("background-color", "rgb(231, 231, 231)");
	        $(".complete").off("click", submit);
	    } else {
	        $(".tips").text("(" + phptos + "/10)");
	    }
	    var removeHtml = $(this).parents(".imgBox");
	    // console.log($(removeHtml))
	    $(removeHtml).remove();
	    if (phptos == 9) {
	        $(document).on("click", ".addImg", imgUp);
	    }
	
	});
	
	function submit() {
	    // type为1，业者选择接受服务单位，还要跳转同意和公司的协议
	    if (type == 1) {
	        // 储存图片地址进sessionStorage
	        // var contractImg = [];
	        var targetImgs = $(".targetImg");
	        var targetImg = [];
	        for (var i = 0; i < targetImgs.length; i++) {
	            console.log(targetImgs[i].src)
	            targetImg.push(targetImgs[i].src)
	
	        }
	        // for (var i = 0; i < targetImg.length; i++) {
	
	        //     plus.zip.compressImage({
	        //             src: targetImg[i].src,
	        //             dst: '_doc/zip_' + targetImg[i].src.substr(targetImg[i].src.lastIndexOf('/') + 1),
	        //             quality: 60, //质量1-100	
	        //             overwrite: true,
	        //             width: "50%", //缩小到原来的一半			
	        //             height: "50%" //缩小到原来的一半		
	        //         },
	        //         function(event) {
	        //             contractImg.push(event.target);
	        //         },
	        //         function(error) {
	        //             // errorTips("图片上传出错");
	        //             console.log("压缩失败:" + error.message);
	        //         });
	        // }
	        // console.log(JSON.stringify(contractImg))
	        // sessionStorage只能存储字符串，先把数据以字符串的形式存着，
	        // 到了onLineContract页面取出来再序列化
	        // setTimeout(() => {
	        // console.log(targetImg.length);
	        // console.log(JSON.stringify(targetImg))
	        sessionStorage.setItem("contractImg", JSON.stringify(targetImg));
	        // hasContractImg 判断是否要向服务器提交协议图片
	        sessionStorage.setItem("hasContractImg", 1);
	        sessionStorage.setItem("yz_sf_xieyiID", 0);
	        location.href = "./onLineContract.html";
	        // }, 1000);
	
	    }
	}
	
	
	
	//弹出系统按钮选择框
	function imgUp() {
	    plus.nativeUI.actionSheet({
	        cancel: "取消",
	        buttons: [
	            { title: "拍摄" },
	            { title: "相册" }
	        ]
	    }, function(e) { //1 是拍照  2 从相册中选择 
	        switch (e.index) {
	            case 1:
	                appendByCamera();
	
	                break;
	            case 2:
	                appendByGallery();
	                break;
	        }
	    });
	}
	
	var phptos = 0;
	// 拍照添加文件
	function appendByCamera() {
	    plus.camera.getCamera().captureImage(function(e) {
	        // console.log("e is" + e);
	        plus.io.resolveLocalFileSystemURL(e, function(entry) {
	            phptos += 1;
	            $(".complete").css("background-color", "#7EB6FF");
	            $(".complete").on("click", submit);
	            if (phptos >= 10) {
	                $(document).off("click", ".addImg", imgUp);
	            }
	            var path = entry.toLocalURL();
	            var imgHtmlStr = `
	                <img class="targetImg" src="${path}" alt="">
	                <div class="delBox">
	                    <img class="del" src="../../img/del.png" alt="">
	                </div>
	            `;
	            var imgBoxHtmlStr = `
	                <div class="imgBox addImg">
	                    <img class="bgImg" src="../../img/camera.png" alt="">
	                    <div class="tips">(${phptos}/10)</div>
	                </div>     
	            `;
	            $(".addImg").html(imgHtmlStr);
	            $(".addImg").removeClass("addImg");
	            $(".photosBox").append(imgBoxHtmlStr);
	        }, function(e) {
	            mui.toast("读取拍照文件错误：" + e.message);
	        });
	
	    });
	}
	
	// 从相册添加文件
	function appendByGallery() {
	    console.log(phptos)
	    var maxNum = 10 - phptos;
	    plus.gallery.pick(function(path) {
	        phptos += path.files.length;
	        if (phptos >= 10) {
	            phptos = 10;
	            $(document).off("click", ".addImg", imgUp);
	        }
	
	        var paths = path.files.length;
	
	        // console.log(phptos)
	        // alert(typeof(path.files.length))  //number
	        var imgHtmlStr = "";
	        var imgBoxHtmlStr = `
	                <div class="imgBox addImg">
	                    <img class="bgImg" src="../../img/camera.png" alt="">
	                    <div class="tips">(${phptos}/10)</div>
	                </div>     
	            `;
	        for (var i = 0; i < paths; i++) {
	
	            imgHtmlStr += `
	                        <div class="imgBox">
	                            <img class="targetImg" src="${path.files[i]}" alt="">
	                            <div class="delBox">
	                                <img class="del" src="../../img/del.png" alt="">
	                            </div>
	                        </div>
	                    `;
	
	
	        }
	
	        $(".addImg").remove();
	        $(".photosBox").append(imgHtmlStr);
	        $(".photosBox").append(imgBoxHtmlStr);
	        $(".complete").css("background-color", "#7EB6FF");
	        $(".complete").on("click", submit);
	    }, function(e) {
	        console.log("取消选择图片");
	    }, {
	        filter: "image",
	        multiple: true,
	        maximum: maxNum,
	        system: false,
	        onmaxed: function() {
	            plus.nativeUI.alert('最多只能选择' + maxNum + '张图片');
	        }
	    });
	}
	
	// document.addEventListener("DOMContentLoaded", function(event) {
	//     ImagesZoom.init({
	//         "elem": ".list"
	//     });
	// }, false);
</script>

</html>